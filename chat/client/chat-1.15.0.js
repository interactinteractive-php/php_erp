function onChatUserImgError(t){return t.src="assets/custom/addon/admin/layout4/img/user.png",!(t.onerror="")}function nl2br(t,e){return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(e||void 0===e?"<br />":"<br>")+"$2")}function replaceURLWithHTMLLinks(t){return t.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,"<a target=\"_blank\" href='$1'>$1</a>")}function linkify(t){var e=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,o=t.replace(e,'<a href="$1" target="_blank">$1</a>'),t=/(^|[^\/])(www\.[\S]+(\b|$))/gim,e=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;return o=(o=o.replace(t,'$1<a href="http://$2" target="_blank">$2</a>')).replace(e,'<a href="mailto:$1">$1</a>')}function encodeEmojis(t){var e,o=t.replace(/[\u{1f300}-\u{1f5ff}\u{1f900}-\u{1f9ff}\u{1f600}-\u{1f64f}\u{1f680}-\u{1f6ff}\u{2600}-\u{26ff}\u{2700}-\u{27bf}\u{1f1e6}-\u{1f1ff}\u{1f191}-\u{1f251}\u{1f004}\u{1f0cf}\u{1f170}-\u{1f171}\u{1f17e}-\u{1f17f}\u{1f18e}\u{3030}\u{2b50}\u{2b55}\u{2934}-\u{2935}\u{2b05}-\u{2b07}\u{2b1b}-\u{2b1c}\u{3297}\u{3299}\u{303d}\u{00a9}\u{00ae}\u{2122}\u{23f3}\u{24c2}\u{23e9}-\u{23ef}\u{25b6}\u{23f8}-\u{23fa}]/gu,t=>"<emoji>&#x"+t.codePointAt(0).toString(16)+";</emoji>"),a={":D":"<emoji>&#x1F603;</emoji>",":d":"<emoji>&#x1F603;</emoji>",":P":"<emoji>&#x1F60B;</emoji>",":p":"<emoji>&#x1F60B;</emoji>",":)":"<emoji>&#x1F642;</emoji>","<3":"<emoji>&#x2764;&#xFE0F;</emoji>","(Y)":"<emoji>&#x1F44D;</emoji>","(y)":"<emoji>&#x1F44D;</emoji>",":(":"<emoji>&#x1F641;</emoji>",":O":"<emoji>&#x1F632;</emoji>",":o":"<emoji>&#x1F632;</emoji>",":*":"<emoji>&#x1F618;</emoji>",";)":"<emoji>&#x1F609;</emoji>",";(":"<emoji>&#x1F625;</emoji>","(n)":"<emoji>&#x1F44E;</emoji>"};for(e in a)o=o.replace(e,a[e]);return o}function getChatMessageIdsByElement(t,e){for(var o=[],a=e.find('[data-in="0"]'),s=a.length,n=0;n<s;n++){var i=$(a[n]);o.push(i.attr("data-mid")),i.attr("data-in","1")}return mgChat.updateUnreadCount(t,s),o}function chatRemoveMsg(t){var e="dialog-chat-msg-confirm";$("#"+e).length||$('<div id="'+e+'"></div>').appendTo("body");var s=$("#"+e),o=t.closest(".chat-user-message"),a=o.attr("data-mid");$.ajax({type:"post",url:"chat/checkRemoveChatMsg",data:{mid:a},dataType:"json",success:function(t){PNotify.removeAll(),"success"==t.status?(t.isMass?(s.empty().append(t.message),s.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:plang.get("msg_title_confirm"),width:410,height:"auto",modal:!0,buttons:[{text:plang.get("all_user"),class:"btn green-meadow btn-sm",click:function(){$.ajax({type:"post",url:"chat/removeMassChatMsg",data:{headerId:t.headerId},dataType:"json",success:function(t){if(PNotify.removeAll(),"success"==t.status){var e,o=t.list,a=$("#chatboxes_wide");for(e in o)rtc.removeMessage(o[e].cid,o[e].mid),a.find('[data-mid="'+o[e].mid+'"]').remove();s.dialog("close")}else new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1})},error:function(){alert("Error")}})}},{text:plang.get("current_user"),class:"btn btn-primary btn-sm",click:function(){$.ajax({type:"post",url:"chat/removeChatMsg",data:{mid:a,isIgnoreFile:1},dataType:"json",success:function(t){var e;PNotify.removeAll(),"success"==t.status?(e=o.closest(".chat-popup"),rtc.removeMessage(e.attr("data-cid"),a),o.remove(),s.dialog("close")):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1})},error:function(){alert("Error")}})}},{text:plang.get("PL_0062"),class:"btn blue-madison btn-sm",click:function(){s.dialog("close")}}]})):(s.empty().append(plang.get("msg_delete_confirm")),s.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Confirm",width:350,height:"auto",modal:!0,buttons:[{text:plang.get("yes_btn"),class:"btn green-meadow btn-sm",click:function(){$.ajax({type:"post",url:"chat/removeChatMsg",data:{mid:a},dataType:"json",success:function(t){var e;PNotify.removeAll(),"success"==t.status?((e=o.closest(".chat-popup")).hasClass("private-chat-popup")?rtc.removeMessage(e.attr("data-cid"),a):(e=e.attr("data-gid"),rtc.removeGroupMessage(e,mgChat.groups[e],a)),o.remove(),s.dialog("close")):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1})},error:function(){alert("Error")}})}},{text:plang.get("no_btn"),class:"btn blue-madison btn-sm",click:function(){s.dialog("close")}}]})),s.dialog("open")):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1})}})}function chatForwardMsg(t){var e="dialog-chat-msg-confirm";$("#"+e).length||$('<div id="'+e+'"></div>').appendTo("body");var c=$("#"+e),o=t.closest(".chat-user-message"),d=o.attr("data-mid"),e=o.find(".chat-msg").clone(),t=e.find(".chat-forward-msg-parent"),o=e.html();t.length&&(a=t.find(".chat-forward-msg").html(),e.find(".chat-forward-msg-parent").remove(),""==(o=e.html())&&(o=a));var a=[],s=[],n=0;for(r in a.push('<div class="chat-forward-preview">'),a.push('<div class="chat-forward-preview-msg">'),a.push(o),a.push("</div>"),a.push('<textarea class="form-control" placeholder="Энд мессеж бичнэ үү (заавал биш)" spellcheck="false" maxlength="4000" rows="1"></textarea>'),a.push("</div>"),a.push('<div class="chat-forward-find-user">'),a.push('<div class="input-group mt-2 mb-2">'),a.push('<div class="form-group-feedback form-group-feedback-left">'),a.push('<input type="text" class="form-control form-control-lg forward-user-search" placeholder="Хайх..." spellcheck="false">'),a.push('<div class="form-control-feedback form-control-feedback-lg">'),a.push('<i class="icon-search4 text-muted"></i>'),a.push("</div>"),a.push("</div>"),a.push("</div>"),a.push("</div>"),mgChat.users){var i=mgChat.users[r],r=r.replace("_","");if(i.lastChatId&&mgChat.supportUserId!=r&&(s.push(chatUserItemRender(i,d)),++n==chatItemLimit))break}a.push('<div class="chat-forward-users" data-lastid="'+r+'" data-scroll="on">'),a.push('<ul class="media-list">'),a.push(s.join("")),a.push("</ul>"),a.push("</div>"),c.empty().append(a.join("")),c.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Forward message",width:530,height:"auto",modal:!0,close:function(){c.empty().dialog("destroy").remove()},buttons:[{text:plang.get("close_btn"),class:"btn blue-madison btn-sm",click:function(){c.dialog("close")}}]}),c.dialog("open"),c.on("keyup",".forward-user-search",function(t){var e=$(this).val(),t=t.keyCode||t.which,o=mgChat.users,a=c.find(".chat-forward-users ul.media-list");if(1<e.length){var s=new RegExp(e,"i");for(n in a.empty(),o)n=n.replace("_",""),mgChat.supportUserId!=n&&s.test(o["_"+n].firstName)&&(r=o["_"+n],a.append(chatUserItemRender(r,d)))}else if(8==t||46==t){var n,i=0;for(n in o){var r=o[n];if(n=n.replace("_",""),r.lastChatId&&mgChat.supportUserId!=n&&(a.append(chatUserItemRender(r,d)),++i==chatItemLimit))break}c.find(".chat-forward-users ul.media-list").attr("data-lastid",n)}}),c.find('.chat-forward-users:not([data-scroll="off"])').on("scroll",function(){var t=$(this),e=t.get(0);if(e.scrollTop+e.clientHeight+1>=e.scrollHeight){var o=t.attr("data-lastid"),a=mgChat.users,s=0,n=t.find("ul.media-list");for(r in a){var i=a[r],r=r.replace("_","");if(i.lastChatId&&mgChat.supportUserId!=r&&(r==o&&(s=1),s)){if(n.append(chatUserItemRender(i,d)),s==chatItemLimit)break;s++}}2==s?t.attr("data-scroll","off"):t.attr("data-lastid",r)}})}function chatUserItemRender(t,e){var o,a=[],s=t.userId,n="";return rtc.connections[s]&&(n=(o=rtc.connections[s].data.userData).hasOwnProperty("status")&&"idle"==o.status?" chat_idle_icon":" online_icon"),a.push('<li class="media align-items-center">'),a.push('<div class="mr-2 position-relative">'),a.push('<img src="api/image_thumbnail?width=36&src='+t.picture+'" class="media-object connectionIcon rounded-circle user_img" onerror="onChatUserImgError(this);">'),a.push('<span class="is-online'+n+'"></span>'),a.push("</div>"),a.push('<div class="media-body">'),a.push('<span class="media-title font-weight-bold text-default">'+$.fn.mgVideoChat.htmlspecialchars(t.fullName)+"</span>"),a.push('<span class="font-size-sm text-muted d-block">'+$.fn.mgVideoChat.htmlspecialchars(t.departmentName)+"</span>"),a.push("</div>"),a.push('<div class="align-self-center ml-3">'),a.push('<button type="button" class="btn btn-sm btn-primary rounded-round" onclick="chatForwardSendMsg(this, '+s+", "+e+');">Илгээх</button>'),a.push("</div>"),a.push("</li>"),a.join("")}function chatForwardSendMsg(t,n,e){var i=$(t),r=i.closest(".ui-dialog-content").find("textarea").val();$.ajax({type:"post",url:"chat/chatForwardMessage",data:{userId:n,mid:e,msg:encodeEmojis(r)},dataType:"json",success:function(t){var e,o,a,s;"success"==t.status?(e=t.forwardData,o=e.id,a=e.date,s={messageText:r,forwardData:e},rtc.chatMessage(n,rtc.connectionId,s,o,a,0,function(){mgChat.isOpenChatBox(n)&&(rtc.stopTyping(n),mgChat.renderChatMessage({chatId:n,fromId:rtc.connectionId,message:r,mid:o,sysDateTime:a,isFile:!1,forwardData:e}))}),mgChat.toTopUser(n,o),i.prop("disabled",!0).html('<i class="far fa-check"></i> Илгээсэн')):(PNotify.removeAll(),new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}))}})}function chatUserStatusItem(t){var e=[];return e.push('<li class="media" data-id="'+t.id+'">'),e.push('<div class="mr-2">'),"1"==t.isActive?e.push('<span class="chat-user-status-active text-success"><i class="icon-checkmark-circle"></i></span>'):e.push('<span class="chat-user-status-active text-default"><i class="icon-circle"></i></span>'),e.push("</div>"),e.push('<div class="media-body">'+t.status+"</div>"),e.push('<div class="ml-1">'),e.push('<button type="button" class="btn btn-outline bg-primary text-primary-800 btn-icon rounded-round chat-status-action" data-action="edit" title="Засах"><i class="icon-pencil7"></i></button>'),e.push('<button type="button" class="btn btn-outline bg-pink-400 text-pink-800 btn-icon rounded-round chat-status-action" data-action="delete" title="Устгах"><i class="icon-trash"></i></button>'),e.push("</div>"),e.push("</li>"),e.join("")}function setChatUserStatus(t){return t||"Та төлөвөө оруулна уу"}function chatDeleteConversations(t,e){$("#connection_"+t).find(".unread-msg").parent().remove(),e.length&&(e.attr("data-pagenum","1"),e.find(".popup-messages").empty())}function chatPageTitleNotifyOff(){"undefined"!=typeof pageTitleNotification&&pageTitleNotification.off()}function getUidSysdate(){var e="";$.ajax({type:"post",url:"api/getUidSysdate",async:!1,success:function(t){e=t}});var t=e.split("|");return{id:t[0],date:t[1]}}function apiChatSendMessage(t,e,o,a){if(t==rtc.connectionId)return!1;var s=getUidSysdate(),n=s.id,i=s.date;return void 0!==a&&a?rtc.chatMessage(t,rtc.connectionId,e,n,i,o,function(){mgChat.isOpenChatBox(t)?(rtc.stopTyping(t),mgChat.renderChatMessage({chatId:t,fromId:rtc.connectionId,message:e,mid:n,sysDateTime:i,isFile:!1})):(mgChat.renderChatBox({connectionId:t,mid:null,isNew:!1,isReadUpdate:!0,isClickItem:!0}),rtc.openChatBox(t))}):rtc.chatMessage(t,rtc.connectionId,e,n,i,o),mgChat.toTopUser(t,n),!0}!function(u,i,r){rtc.chatMessage=function(t,e,o,a,s,n,i){var r,c=!1;isObject(o)?(o=encodeEmojis((r=o).messageText),r.messageText=o,rtc.chatMessageNotAjax(t,r,a,s,n,0),r.hasOwnProperty("forwardData")&&(c=!0)):(o=encodeEmojis(o),rtc.chatMessageNotAjax(t,o,a,s,n,0)),void 0!==i&&i(),0==c&&u.ajax({type:"post",url:"chat/message",data:{mid:a,messageText:o,to:t,isFile:n,sysDateTime:s},dataType:"json",success:function(t){"success"!==t.status?console.log("save error: "+t.status):void 0!==i&&i()},error:function(){console.log("save error")}})},rtc.chatMessageNotAjax=function(t,e,o,a,s,n){s={mid:o,connectionId:t,message:"",sysDateTime:a,isFile:s,isRead:0,isMass:n};isObject(e)?(n=e,s.message=n.messageText,n.hasOwnProperty("forwardData")&&(s.forwardData=n.forwardData)):s.message=e,rtc.send({type:"chat_message",data:s})},rtc.groupChatMessage=function(t,e,o,a,s,n,i){rtc.send({type:"group_chat_message",data:{mid:s,groupId:t,groupName:e,members:o,message:a,sysDateTime:n,isFile:i,isRead:0}}),u.ajax({type:"post",url:"chat/groupMessage",data:{mid:s,messageText:a,to:t,isFile:i,sysDateTime:n},dataType:"json",success:function(t){"success"!==t.status&&console.log("save error: "+t.status)},error:function(){console.log("save error")}})},rtc.startTyping=function(t){rtc.connections[t]&&rtc.send({type:"start_typing",data:{connectionId:t}})},rtc.stopTyping=function(t){rtc.connections[t]&&rtc.send({type:"stop_typing",data:{connectionId:t}})},rtc.readMessage=function(t){rtc.connections[t]&&rtc.send({type:"read_message",data:{connectionId:t}})},rtc.readGroupMessage=function(t){rtc.send({type:"read_group_message",data:{connectionId:t}})},rtc.removeMessage=function(t,e){rtc.send({type:"remove_message",data:{connectionId:t,mid:e}})},rtc.fileDownloaded=function(t,e){rtc.send({type:"file_downloaded",data:{connectionId:t,mid:e}})},rtc.removeGroupMessage=function(t,e,o){rtc.send({type:"remove_group_message",data:{groupId:t,mid:o,members:e}})},rtc.renameGroup=function(t,e,o){rtc.send({type:"rename_group",data:{groupId:t,groupName:e,members:o}})},rtc.pushUsersToGroup=function(t,e,o,a){rtc.send({type:"pushusers_togroup",data:{groupId:t,groupName:e,members:o,membersCount:a}})},rtc.pushRemoveUsersToGroup=function(t,e,o,a){rtc.send({type:"pushremoveusers_togroup",data:{groupId:t,removedUsers:o,members:e,membersCount:a}})},rtc.deleteToGroup=function(t,e){rtc.send({type:"delete_group",data:{groupId:t,members:e}})},rtc.exitToGroup=function(t,e,o){rtc.send({type:"exit_group",data:{groupId:t,members:e,membersCount:o}})},rtc.openChatBox=function(t){rtc.send({type:"open_chatbox",data:{connectionId:t}})},rtc.closeChatBox=function(t){rtc.send({type:"close_chatbox",data:{connectionId:t}})},rtc.openGroupChatBox=function(t,e){rtc.send({type:"open_groupchatbox",data:{connectionId:t,groupName:e}})},rtc.closeGroupChatBox=function(t){rtc.send({type:"close_groupchatbox",data:{connectionId:t}})},rtc.deleteConversations=function(t){rtc.connections[t]&&rtc.send({type:"delete_conversations",data:{connectionId:t}})},u.fn.mgDesktopShare=function(t){var e={extensionAvailable:null,screenCallback:null,isExtensionAvailable:function(t){var e=this;if(null!==this.extensionAvailable)return t(this.extensionAvailable);i.postMessage({message:"mgIsLoaded"},"*"),setTimeout(function(){null==e.extensionAvailable&&(e.extensionAvailable=!1),t(e.extensionAvailable)},200)},getSourceId:function(e){var o=this;this.isExtensionAvailable(function(t){t||e(!1,"no-extension"),o.screenCallback=e,i.postMessage({message:"mgGetSourceId"},"*")})}};return i.addEventListener("message",function(t){if(t.origin==i.location.origin)switch(t.data.message){case"mgIsLoadedResult":e.extensionAvailable=!0;break;case"mgGetSourceIdResult":t.data.success?e.screenCallback(t.data.sourceId):e.screenCallback&&e.screenCallback(!1,"no-permission");break;default:return}}),e},u.fn.mgVideoChatRtcEvents=function(t,n,i){t.prototype.initRtc=function(){var s=this;n.on("connected",function(){s.onConnected()}),n.on("connectionId",function(t){s.onRoomOptions()}),n.on("logged",function(){s.fire("logged"),s.onLogged()}),n.on("socket_error",function(t){s.onDisconnected()}),n.on("socket_closed",function(t){s.onDisconnected()}),n.on("chat_message",function(t){var e=!(!t.hasOwnProperty("me")||!t.me),o=t.hasOwnProperty("isMass")&&t.isMass?1:0,a=t.hasOwnProperty("forwardData")?t.forwardData:{};s.fire("chat_message",t),s.renderChatBox({connectionId:t.connectionId,mid:t.mid,isNew:!0,isReadUpdate:!1,isClickItem:!1,isMe:e}),s.renderChatMessage({chatId:t.connectionId,fromId:t.connectionId,message:t.message,mid:t.mid,sysDateTime:t.sysDateTime,isFile:t.isFile,isNew:!0,isMe:e,isMass:o,forwardData:a}),n.connectionId==t.connectionId||e||(s.renderConnection(t.connectionId),":buzz"==t.message?bpSoundPlay("bell"):s.notifySound(),t.hasOwnProperty("notify")&&i.notify("Шинэ чат",{body:"Танд шинэ чат мессеж ирлээ",icon:"assets/custom/img/logo.png"}))}),n.on("group_chat_message",function(t){s.fire("group_chat_message",t);var e=t.groupId,o=!(!t.hasOwnProperty("me")||!t.me);s.renderGroupChatBox({groupId:e,groupName:t.groupName,mid:t.mid,isNew:!0,isReadUpdate:!1,isClickItem:!1,isMe:o}),s.renderGroupChatMessage({groupId:e,fromId:t.connectionId,message:t.message,mid:t.mid,sysDateTime:t.sysDateTime,isFile:t.isFile,isNew:!0,isMe:o}),o||(":buzz"==t.message?bpSoundPlay("bell"):s.notifySound(),t.hasOwnProperty("notify")&&i.notify("Групп чат",{body:"("+t.groupName+") групп дээр шинэ чат мессеж ирлээ",icon:"assets/custom/img/logo.png"}))}),n.on("start_typing",function(t){s.fire("start_typing",t),s.startUserTyping(t.connectionId)}),n.on("stop_typing",function(t){s.fire("stop_typing",t),s.stopUserTyping(t.connectionId)}),n.on("read_message",function(t){s.fire("read_message",t),s.readUserMessage(t)}),n.on("read_group_message",function(t){s.fire("read_group_message",t),s.readUserGroupMessage(t)}),n.on("remove_message",function(t){s.fire("remove_message",t),s.removeUserMessage(t)}),n.on("file_downloaded",function(t){s.fire("file_downloaded",t),s.fileDownloadedMessage(t)}),n.on("remove_group_message",function(t){s.fire("remove_group_message",t),s.removeUserMessage(t)}),n.on("pushusers_togroup",function(t){s.fire("pushusers_togroup",t),s.renderPushUsersToGroup(t)}),n.on("pushremoveusers_togroup",function(t){s.fire("pushremoveusers_togroup",t),s.renderPushRemoveUsersToGroup(t)}),n.on("rename_group",function(t){s.fire("rename_group",t),s.renderRenameGroup(t)}),n.on("delete_group",function(t){s.fire("delete_group",t),s.renderDeleteGroup(t)}),n.on("exit_group",function(t){s.fire("exit_group",t),s.renderExitGroup(t)}),n.on("delete_conversations",function(t){s.fire("delete_conversations",t),s.deleteUserConversations(t)}),n.on("open_chatbox",function(t){s.fire("open_chatbox",t),s.openUserChatBox(t)}),n.on("close_chatbox",function(t){s.fire("close_chatbox",t),s.closeUserChatBox(t)}),n.on("open_groupchatbox",function(t){s.fire("open_groupchatbox",t),s.openUserGroupChatBox(t)}),n.on("close_groupchatbox",function(t){s.fire("close_groupchatbox",t),s.closeUserGroupChatBox(t)}),s.initUsers(),n.on("connection_add",function(t){n.usersCount=t.users_count,n.connectionId!=t.connectionId&&s.supportUserId!=t.connectionId&&("org"!=s.contactsView&&"offline"!=s.contactsView&&"recent"!=s.contactsView&&s.renderConnection(t.connectionId),s.setOnlineConnection(t.connectionId),s.setCountContacts())}),n.on("connection_remove",function(t){n.usersCount=t.users_count,s.onConnectionClose(t.connectionId),s.setCountContacts()}),n.on("connection_online",function(t){s.setOnlineConnection(t.connectionId)}),n.on("connection_idle",function(t){s.setIdleConnection(t.connectionId)}),n.on("connection_changestatus",function(t){s.setUserStatusConnection(t)})}},u.fn.mgVideoChatUI=function(t,x,e){t.prototype.renderConnections=function(){var o=this;0==o.$connectionsPanel.children().length&&o.loadTplByName("tplConnections",function(t){var e=setChatUserStatus(o.userStatus),e=o.tmpl(t,{rows:x.connections,roomOptions:x.roomOptions,usersCount:x.usersCount,userStatus:e});o.$connectionsPanel.empty().append(e),o.selectedContactsView(o.contactsView),o.setCountContacts(),"recent"==o.contactsView?o.renderContactsRecent(!1):"online"==o.contactsView?o.renderContactsOnline(!1):"offline"==o.contactsView?o.renderContactsOffline(!1):"org"==o.contactsView?o.renderContactsOrg(!1):o.renderContactsAll(!1),o.initChatContactsScroll(),o.prependSupportChatBtn(),o.fire("connections",x.connections)})},t.prototype.renderContactsAll=function(t){var e=this,o=0,a=e.$connectionsPanel.find(".chat_contacts_body");for(s in e.$connectionsPanel.find("#userlistbox").empty(),a.attr({"data-scroll":"on","data-lastid":""}),x.connections)if(e.supportUserId!=s&&(e.renderConnection(s),++o==chatItemLimit))break;if(o<chatItemLimit)for(var s in e.users)if(s=s.replace("_",""),!x.connections[s]&&e.supportUserId!=s&&(e.renderConnection(s),++o==chatItemLimit))break;e.users.length<=chatItemLimit?a.attr("data-scroll","off"):a.attr("data-lastid",s),e.setChatUserToolip(a)},t.prototype.renderContactsRecent=function(t){var e=this;if(!t||"recent"!=e.contactsView){var o=0,t=e.$connectionsPanel.find(".chat_contacts_body");for(s in e.$connectionsPanel.find("#userlistbox").empty(),t.attr({"data-scroll":"on","data-lastid":""}),e.users){var a=e.users[s],s=s.replace("_","");if(a.lastChatId&&e.supportUserId!=s&&(e.renderConnection(s),++o==chatItemLimit))break}t.attr("data-lastid",s),e.setChatUserToolip(t)}},t.prototype.renderContactsOnline=function(t){var e=this;if(!t||"online"!=e.contactsView){t=e.$connectionsPanel.find(".chat_contacts_body");e.$connectionsPanel.find("#userlistbox").empty(),t.attr({"data-scroll":"on","data-lastid":""});var o=x.connections;if(Object.keys(o).length){for(var a in e.users)o[a=a.replace("_","")]&&e.supportUserId!=a&&e.renderConnection(a);e.setChatUserToolip(e.$connectionsPanel)}else console.log("no online connections")}},t.prototype.renderContactsOffline=function(t){var e=this;if(!t||"offline"!=e.contactsView){var o,a=0,t=e.$connectionsPanel.find(".chat_contacts_body");for(o in e.$connectionsPanel.find("#userlistbox").empty(),t.attr({"data-scroll":"on","data-lastid":""}),e.users)if(o=o.replace("_",""),!x.connections[o]&&e.supportUserId!=o&&(e.renderConnection(o),++a==chatItemLimit))break;e.users.length<=chatItemLimit?t.attr("data-scroll","off"):t.attr("data-lastid",o),e.setChatUserToolip(t)}},t.prototype.renderContactsOrg=function(t){var s=this;t&&"org"==s.contactsView||(s.$connectionsPanel.find(".chat_contacts_body").attr({"data-scroll":"on","data-lastid":""}),u.ajax({type:"post",url:"chat/getChatOrgList",dataType:"json",beforeSend:function(){Core.blockUI({target:s.$connectionsPanel,animate:!0})},success:function(t){var e,o="";for(e in t)o+='<div class="chat-org-item" data-orgname="'+t[e].DEPARTMENT_NAME+'" title="'+t[e].DEPARTMENT_NAME+'"><div class="card-header"><h6 class="card-title"><a data-toggle="collapse" class="text-default collapsed" href="#chat-org-accordion'+t[e].DEPARTMENT_ID+'" data-id="'+t[e].DEPARTMENT_ID+'"><i class="icon-folder2 mr-1"></i>'+t[e].DEPARTMENT_NAME+'</a></h6></div><div id="chat-org-accordion'+t[e].DEPARTMENT_ID+'" class="collapse" data-parent="#chat-org-accordion"></div></div>';var a='<div class="card-group-control card-group-control-right" id="chat-org-accordion"><div class="card">'+o+"</div></div>";s.$connectionsPanel.find("#userlistbox").empty().append(a),Core.unblockUI(s.$connectionsPanel)}}))},t.prototype.selectedContactsView=function(t){var e=this.$connectionsPanel.find(".chat-view-dropdown");e.find(".chat-contacts-selected").remove(),e.find('a[data-view="'+t+'"]').append('<i class="icon-checkmark3 text-gray ml-auto chat-contacts-selected"></i>')},t.prototype.setCountContacts=function(){var t=Number(this.contactsCount),e=x.connections,o=0;if(Object.keys(e).length){for(var a in e)this.users["_"+a]&&o++;e[this.supportUserId]&&o&&o--}u("#chat-online-count").text(o),u("#chat-offline-count").text(t-o)},t.prototype.renderConnection=function(t){var e=this;0==e.$connectionsPanel.find("#connection_"+t).length&&e.getConnectionElement(t,function(t){e.$connectionsPanel.find("#userlistbox").append(t)})},t.prototype.getConnectionElement=function(c,d){var l=this;if(!l.users.hasOwnProperty("_"+c))return!1;this.loadTplByName("tplConnection",function(t){var e,o,a=x.connections,s=l.users["_"+c],n=!0,i=!1,r="";a.hasOwnProperty(c)?(o=(e=a[c]).status||"idle",(a=e.data.userData).hasOwnProperty("status")&&"idle"==a.status&&(i=!0)):(e={},n=!(o="idle")),"0"!=s.unReadCount&&(r='<div><span class="unread-msg">'+s.unReadCount+"</span></div>");r={id:c,status:o,userData:s,unread:r},r=u(l.tmpl(t,r));n&&(i?r.find(".is-online").addClass("chat_idle_icon"):r.find(".is-online").addClass("online_icon")),d(r)})},t.prototype.isOpenChatBox=function(t){return!!this.$chatboxesWide.find("#chatbox-"+t).length},t.prototype.renderChatBox=function(o){var a=this,s=o.connectionId,n=o.mid,i=o.isNew,r=o.isReadUpdate,c=o.isClickItem,t=a.$chatboxesWide.find("#chatbox-"+s);0==t.length?(a.loadTplByName("tplChatBox",function(t){var e=a.users["_"+s],t=a.tmpl(t,{id:s,name:e.fullName,picture:e.picture}),e=u(t);x.connections[s]&&((t=x.connections[s].data.userData).hasOwnProperty("status")&&"idle"==t.status?e.find(".is-online").addClass("chat_idle_icon"):e.find(".is-online").addClass("online_icon")),a.$chatboxesWide.append(e),a.setWidthChatBox(),a.getHistoryMessages(e,s,n,1,30,!0,r,c),a.initChatBoxScroll(e),a.initChatBoxResizable(e),i&&(!o.hasOwnProperty("isMe")||o.hasOwnProperty("isMe")&&!o.isMe)&&a.setNewMsgHeaderColorChatBox(s,e,o.hasOwnProperty("ignoreIncreaseUnread")),c&&a.initChatBoxCursorFocus(e),u().autogrow&&e.find("textarea").autogrow(),x._socketTimer&&e.find("textarea").prop("disabled",!0)}),u().emojiChooser||(u("head").append('<link rel="stylesheet" type="text/css" href="assets/custom/addon/plugins/emoji-picker/css/jquery.emojichooser.css?v=4"/>'),u.cachedScript("assets/custom/addon/plugins/emoji-picker/js/jquery.emojichooser.js"))):i&&(!o.hasOwnProperty("isMe")||o.hasOwnProperty("isMe")&&!o.isMe)&&(a.setNewMsgHeaderColorChatBox(s,t),c&&a.initChatBoxCursorFocus(t))},t.prototype.getHistoryMessages=function(h,m,g,f,t,y,v,b){var C=this;u.ajax({type:"post",url:"chat/getChatHistoryMessages",data:{to:m,page:f,rows:t,isReadUpdate:v},dataType:"json",success:function(p){p.length?C.loadTplByName("tplChat",function(t){var e,o,a=h.find(".popup-messages"),s="",n="",i=null;for(e in y||(d=a.find(".chat-user-message:eq(0)")),p)g!=p[e].ID&&(n=1==p[e].IS_FILE?C.parseChatMessageFile(p[e].MESSAGE,p[e].IS_FILE_DOWNLOADED):""!=p[e].FORWARD_DATE&&null!==p[e].FORWARD_DATE?C.parseChatForwardText(p[e].MESSAGE,{msg:p[e].FORWARD_MESSAGE,userFullName:p[e].FORWARD_USER_NAME,createdDate:p[e].FORWARD_DATE}):C.parseChatMessageText(p[e].MESSAGE),o={me:p[e].FROM_ID===x.connectionId,message:n,dateTime:date("Y/m/d H:i",strtotime(p[e].CREATED_DATE)),mid:p[e].ID,isRead:p[e].READ,isMassMsg:p[e].HEADER_ID?1:0},s=C.tmpl(t,o)+s,1!=o.me||i||1!=o.isRead||(i=o.mid));var r,c,d,l=p[0],u=l.FROM_ID===x.connectionId,l=l.READ;a.prepend(s),h.attr("data-pagenum",f),b&&"0"==l&&0==u?(x.readMessage(m),i&&(r=h.find(".popup-head img.user_img").attr("src"),c=h.find(".popup-head .username").text(),a.find('[data-mid="'+i+'"]').after('<span class="chat-message-read"><img src="'+r+'" title="'+c+'" onerror="onChatUserImgError(this);"></span>'))):b&&"1"==l&&1==u?(r=h.find(".popup-head img.user_img").attr("src"),c=h.find(".popup-head .username").text(),a.find(".chat-message-read").remove(),a.append('<span class="chat-message-read"><img src="'+r+'" title="'+c+'" onerror="onChatUserImgError(this);"></span>')):i&&(r=h.find(".popup-head img.user_img").attr("src"),c=h.find(".popup-head .username").text(),a.find('[data-mid="'+i+'"]').after('<span class="chat-message-read"><img src="'+r+'" title="'+c+'" onerror="onChatUserImgError(this);"></span>')),y?setTimeout(function(){a.scrollTop(5e4)},10):d.length&&a.scrollTop(d.offset().top-450),!v||(d=a.find('[data-in="0"]').length)&&C.updateUnreadCount(m,d)}):h.attr("data-scroll","off")},error:function(){console.log("get histortylist error")}})},t.prototype.getHistoryGroupMessages=function(h,t,m,g,e,f,o,a){var y=this;u.ajax({type:"post",url:"chat/getGroupChatHistoryMessages",data:{to:t,page:g,rows:e,isReadUpdate:o},dataType:"json",success:function(p){p.length?y.loadTplByName("tplGroupChat",function(t){var e,o,a,s=h.find(".popup-messages"),n="",i="",r={},c=!1,d="",l="",u=x.connections;for(o in f||(e=s.find(".chat-user-message:eq(0)")),p)m!=p[o].ID&&(c=!1,l=d="",i=1==p[o].IS_FILE?y.parseChatMessageFile(p[o].MESSAGE,0):y.parseChatMessageText(p[o].MESSAGE),p[o].FROM_ID===x.connectionId?c=!0:(r=y.users.hasOwnProperty("_"+p[o].FROM_ID)?y.users["_"+p[o].FROM_ID]:{picture:"",fullName:p[o].USER_FULL_NAME},d='<div class="group-chat-user chatuser-'+p[o].FROM_ID+'">',d+='<img class="rounded-circle mr-1" src="api/image_thumbnail?width=35&src='+r.picture+'" onerror="onChatUserImgError(this);" title="'+r.fullName+'">',u.hasOwnProperty(p[o].FROM_ID)?d+='<span class="is-online chat-group-online-icon"></span>':d+='<span class="is-online"></span>',d+="</div>",l='<span class="group-user-name">'+r.fullName+"</span>"),a={me:c,message:i,dateTime:date("Y/m/d H:i",strtotime(p[o].CREATED_DATE)),mid:p[o].ID,isRead:p[o].READ,memberPicture:d,memberName:l},n=y.tmpl(t,a)+n);s.prepend(n),h.attr("data-pagenum",g),f?setTimeout(function(){s.scrollTop(5e4)},10):e.length&&s.scrollTop(e.offset().top-450)}):h.attr("data-scroll","off")},error:function(){console.log("get histortylist error")}})},t.prototype.updateUnreadCount=function(t,e){var o,a=u("#connection_"+t+" .unread-msg");a.length?(o=Number(a.text())-e)<=0?(a.remove(),o=0):a.text(o):(o=Number(this.users["_"+t].unReadCount)-e)<=0&&(o=0),this.users["_"+t].unReadCount=o},t.prototype.renderGroupChatBox=function(e){var o=this,t=o.$chatboxesWide.find("#groupchatbox-"+e.groupId);0==t.length?o.loadTplByName("tplGroupChatBox",function(t){t=o.tmpl(t,{id:e.groupId,name:e.groupName}),t=u(t);o.$chatboxesWide.append(t),o.setWidthChatBox(),o.getHistoryGroupMessages(t,e.groupId,e.mid,1,30,!0,e.isReadUpdate,e.isClickItem),o.initGroupChatBoxScroll(t),o.initChatBoxResizable(t),e.isNew&&(!e.hasOwnProperty("isMe")||e.hasOwnProperty("isMe")&&!e.isMe)&&o.setNewMsgHeaderColorGroupChatBox(e.groupId,t),e.isClickItem&&o.initChatBoxCursorFocus(t),u().autogrow&&t.find("textarea").autogrow(),x._socketTimer&&t.find("textarea").prop("disabled",!0)}):e.isNew&&(!e.hasOwnProperty("isMe")||e.hasOwnProperty("isMe")&&!e.isMe)&&(o.setNewMsgHeaderColorGroupChatBox(e.groupId,t),e.isClickItem&&o.initChatBoxCursorFocus(t))},t.prototype.setWidthChatBox=function(){var t,e=this.$chatboxesWide.find(".chat-popup");e.length&&(t=u(".chatBox").hasClass("showBox")?307:67,e.each(function(){u(this).css("right",t),t+=310}))},t.prototype.initChatBoxScroll=function(e){var o=this;e.find('.popup-messages:not([data-scroll="off"])').on("scroll",function(){var t;0==u(this).scrollTop()&&(t=Number(e.attr("data-pagenum"))+1,o.getHistoryMessages(e,e.attr("data-cid"),null,t,30,!1,!0,!1))})},t.prototype.initGroupChatBoxScroll=function(e){var o=this;e.find('.popup-messages:not([data-scroll="off"])').on("scroll",function(){var t;0==u(this).scrollTop()&&(t=Number(e.attr("data-pagenum"))+1,o.getHistoryGroupMessages(e,e.attr("data-gid"),null,t,30,!1,!0,!1))})},t.prototype.initChatBoxResizable=function(t){t.resizable({handles:"n",minHeight:200,maxHeight:u(i).height()-10,resize:function(t,e){var o=u(this);o.css({top:"",height:""}),o.find(".popup-messages").css("height",e.size.height-85)}})},t.prototype.initChatBoxResizableDestroy=function(t){t.resizable("destroy")},t.prototype.initChatBoxCursorFocus=function(t){t.find("textarea").focus()},t.prototype.initChatContactsScroll=function(){var r=this;r.$connectionsPanel.find('.chat_contacts_body:not([data-scroll="off"])').on("scroll",function(){if("org"!=r.contactsView){var t=u(this),e=t.get(0);if(e.scrollTop+e.clientHeight+1>=e.scrollHeight){var o=t.attr("data-lastid"),a=r.users,s=0;if("recent"==r.contactsView)for(var n in a){var i=a[n],n=n.replace("_","");if(i.lastChatId&&r.supportUserId!=n&&(n==o&&(s=1),s)){if(r.renderConnection(n),s==chatItemLimit)break;s++}}else if("online"==r.contactsView){e=x.connections;if(Object.keys(e).length)for(var n in e)if(r.supportUserId!=n&&(n==o&&(s=1),s)){if(r.renderConnection(n),s==chatItemLimit)break;s++}}else if("offline"==r.contactsView){for(var n in a)if(n=n.replace("_",""),!x.connections[n]&&r.supportUserId!=n&&(n==o&&(s=1),s)){if(r.renderConnection(n),s==chatItemLimit)break;s++}}else for(var n in a)if(n=n.replace("_",""),r.supportUserId!=n&&(n==o&&(s=1),s)){if(r.renderConnection(n),s==chatItemLimit)break;s++}2==s?t.attr("data-scroll","off"):t.attr("data-lastid",n),r.setChatUserToolip(r.$connectionsPanel)}}})},t.prototype.prependSupportChatBtn=function(){this.supportUserId&&this.$connectionsPanel.find(".chat-dropdown-options").prepend('<button type="button" class="btn dropdown-toggle p-0 mr5" title="Онлайн туслах" id="chat-online-support"><i class="ci-icon-help text-white"></i></button>')},t.prototype.setOnlineConnection=function(t){var e=this,o=x.connections[t];"offline"==e.contactsView?e.$connectionsPanel.find("#connection_"+t).remove():e.$connectionsPanel.find("#connection_"+t+" .is-online").removeClass("chat_idle_icon").addClass("online_icon"),e.$chatboxesWide.find("#chatbox-"+t+" .is-online").removeClass("chat_idle_icon").addClass("online_icon"),e.$chatboxesWide.find(".chatuser-"+t+" .is-online").removeClass("chat-group-idle-icon").addClass("chat-group-online-icon"),o&&(x.connections[t].data.userData.status="online")},t.prototype.setIdleConnection=function(t){var e=this,o=x.connections[t];"offline"==e.contactsView?e.$connectionsPanel.find("#connection_"+t).remove():e.$connectionsPanel.find("#connection_"+t+" .is-online").removeClass("online_icon").addClass("chat_idle_icon"),e.$chatboxesWide.find("#chatbox-"+t+" .is-online").removeClass("online_icon").addClass("chat_idle_icon"),e.$chatboxesWide.find(".chatuser-"+t+" .is-online").removeClass("chat-group-online-icon").addClass("chat-group-idle-icon"),o&&(x.connections[t].data.userData.status="idle")},t.prototype.setUserStatusConnection=function(t){var e=this;e.users["_"+t.connectionId].status=t.status,x.connectionId!=t.connectionId?e.$connectionsPanel.find("#connection_"+t.connectionId).find(".chat-status-name").html(t.status):(e.userStatus=t.status,e.$connectionsPanel.find(".chat-user-status").html(t.status).removeAttr("aria-expanded"),(e=e.$connectionsPanel.find(".chat-user-status-dropdown")).removeClass("show").removeAttr("x-placement style"),e.find("ul.media-list").empty())},t.prototype.setNewMsgHeaderColorChatBox=function(t,e,o){var a=u("#connection_"+t);e.addClass("chat-popup-unread"),e.find(".popup-head").addClass("chat-header-unread"),"undefined"!=typeof pageTitleNotification&&pageTitleNotification.on(plang.get("unread_sms"),1e3),a.length&&((e=a.find(".unread-msg")).length?e.text(Number(e.text())+1):a.find(".media-body").append('<div><span class="unread-msg">1</span></div>')),void 0!==o&&(void 0===o||o)||(this.users["_"+t].unReadCount=Number(this.users["_"+t].unReadCount)+1)},t.prototype.setNewMsgHeaderColorGroupChatBox=function(t,e){e.find(".popup-head").addClass("chat-header-unread"),"undefined"!=typeof pageTitleNotification&&pageTitleNotification.on(plang.get("unread_sms"),1e3)},t.prototype.renderGroups=function(){var n=this,i=u("#grouplistbox");0==i.children().length&&u.ajax({type:"post",url:"chat/getGroups",dataType:"json",success:function(s){s.length&&n.loadTplByName("tplGroup",function(t){var e,o="";for(e in s){var a={id:s[e].ID,name:s[e].NAME,membercount:s[e].MEMBER_COUNT};o+=n.tmpl(t,a)}i.append(o)})}})},t.prototype.newGroupItemRender=function(o,a,s){var n;0==u("#chatgroup_"+o).length&&(n=this).loadTplByName("tplGroup",function(t){var e={id:o,name:a,membercount:s};u("#grouplistbox").prepend(n.tmpl(t,e))})},t.prototype.renderGroupRename=function(t,e){var o=u("#chatgroup_"+t),a=u("#groupchatbox-"+t);o.length&&o.find(".chat-group-name").html(e),a.length&&a.find(".username").html(e).attr("title",e),x.renameGroup(t,e,this.groups[t])},t.prototype.addUsersToGroup=function(t,e,o,a){var s,n=u("#chatgroup_"+t),i=this.groups;for(s in n.length&&n.find(".chat-group-user-count").text(a),i.hasOwnProperty(t)||(this.groups[t]={}),o)this.groups[t][o[s]]=1;x.pushUsersToGroup(t,e,this.groups[t],a)},t.prototype.removeUsersToGroup=function(t,e,o){var a,s=u("#chatgroup_"+t);for(a in s.length&&s.find(".chat-group-user-count").text(o),e)delete this.groups[t][e[a]];x.pushRemoveUsersToGroup(t,this.groups[t],e,o)},t.prototype.groupDelete=function(t){var e=u("#chatgroup_"+t),o=u("#groupchatbox-"+t);e.length&&e.remove(),o.length&&o.remove(),x.deleteToGroup(t,this.groups[t]),delete this.groups[t]},t.prototype.groupExit=function(t){var e=u("#chatgroup_"+t),o=u("#groupchatbox-"+t),a=this.groups[t],s=Object.keys(a).length-1;e.length&&e.remove(),o.length&&o.remove(),x.exitToGroup(t,a,s),delete this.groups[t]},t.prototype.setChatUserToolip=function(t){t.find(".chat-user-item:not([data-hasqtip])").qtip({content:{text:function(t,r){return u.ajax({method:"post",url:"chat/getUserInfo",data:{id:r.elements.target.attr("data-connection_id")},loading:!1,once:!1}).then(function(t){var e=!1;t.hasOwnProperty("isdv")&&(e=!0);var o='<div class="media-body d-flex align-items-center justify-content-center"><div class="col-4 text-center border-right-1 border-gray mr-2"><img src="api/image_thumbnail?width=100&src='+t.picture+'" onerror="onChatUserImgError(this);" class="rounded-circle" style="width:50px;height:50px;"/><h6 class="text-blue font-weight-bold mt-1 mb-1 line-height-normal">'+t.userfullname+'</h6><p class="text-blu mb-0 font-size-12 line-height-normal">'+dvFieldValueShow(t.positionname)+'</p></div><div class="col-8"><ul class="media-list font-size-13">';if(0==e){e=dvFieldValueShow(t.employeeemail);o+='<li class="d-flex flex-row align-items-center"><i class="icon-mail5 text-blue mr-1"></i><a href="mailto:'+e+'">'+e+"</a></li>",t.hasOwnProperty("employeephone")&&""!=t.employeephone&&null!=t.employeephone&&(o+='<li class="d-flex flex-row align-items-center mt10"><i class="icon-phone text-blue mr-1"></i><span>'+dvFieldValueShow(t.employeephone)+"</span></li>"),o+='<li class="d-flex flex-row align-items-center mt10"><i class="icon-mobile text-blue mr-1"></i><span>'+dvFieldValueShow(t.employeemobile)+"</span></li>",o+='<li class="d-flex flex-row align-items-center mt10"><i class="icon-location3 text-blue mr-1"></i><span class="line-height-normal">'+t.departmentname+"</span></li>"}else{var a,s=t.columnConfigs;for(a in delete t.picture,delete t.userfullname,delete t.positionname,delete t.columnConfigs,delete t.isdv,t)if(t[a]){var n,i="";for(n in s)if(s[n].FIELD_PATH==a){i=s[n].ICON_NAME;break}-1!==i.indexOf("fa-")&&(i="fa "+i),o+='<li class="d-flex flex-row align-items-center mt10"><i class="'+i+' text-blue mr-1" style="width: 14px;"></i>'+("employeeemail"==a?'<a href="mailto:'+t[a]+'">'+t[a]+"</a>":'<span class="line-height-normal">'+dvFieldValueShow(t[a])+"</span>")+"</li>"}}o+="</ul></div></div>",r.set("content.text",o)},function(t,e,o){r.set("content.text",e+": "+o)}),"Loading..."}},position:{effect:!1,at:"center left",my:"right center",viewport:u(i)},show:{effect:!1,delay:700},hide:{effect:!1,fixed:!0,delay:70},style:{classes:"qtip-bootstrap",width:450,tip:{width:12,height:7}}})},t.prototype.renderChatMessage=function(a){var t,s=this,n=s.getChatDiv(a.chatId);n.length&&s.loadTplByName("tplChat",function(t){var e={message:a.isFile?s.parseChatMessageFile(a.message,0):a.hasOwnProperty("forwardData")&&a.forwardData?s.parseChatForwardText(a.message,a.forwardData):s.parseChatMessageText(a.message),me:!1,dateTime:date("Y/m/d H:i",strtotime(a.sysDateTime)),mid:a.mid,isRead:1,isMassMsg:a.hasOwnProperty("isMass")?a.isMass:0};a.fromId===x.connectionId||a.hasOwnProperty("isMe")&&a.isMe?(e.me=!0,e.userData=x.userData):e.userData=x.connections[a.fromId].data.userData,a.hasOwnProperty("isNew")&&a.isNew&&(e.isRead=0);var e=s.tmpl(t,e),o=n.find(".popup-messages");o.append(e),setTimeout(function(){o.scrollTop(5e4)},10)}),a.hasOwnProperty("isMass")||(t=s.$connectionsPanel.find("#connection_"+a.chatId)).length&&0!=t.index()&&"org"!=s.contactsView&&(t.remove(),s.getConnectionElement(a.chatId,function(t){s.$connectionsPanel.find("#userlistbox").prepend(t)}))},t.prototype.renderGroupChatMessage=function(n){var i=this,r=i.getGroupChatDiv(n.groupId);r.length&&i.loadTplByName("tplGroupChat",function(t){var e,o,a={message:n.isFile?i.parseChatMessageFile(n.message,0):i.parseChatMessageText(n.message),me:!1,dateTime:date("Y/m/d H:i",strtotime(n.sysDateTime)),mid:n.mid,isRead:1,memberPicture:"",memberName:""};n.fromId===x.connectionId||n.hasOwnProperty("isMe")&&n.isMe?a.me=!0:(e=i.users["_"+n.fromId],o='<span class="is-online"></span>',x.connections.hasOwnProperty(n.fromId)&&(o='<span class="is-online chat-group-online-icon"></span>'),a.memberPicture='<div class="group-chat-user chatuser-'+n.fromId+'"><img class="rounded-circle mr-1" src="api/image_thumbnail?width=35&src='+e.picture+'" onerror="onChatUserImgError(this);" title="'+e.fullName+'">'+o+"</div>",a.memberName='<span class="group-user-name">'+e.fullName+"</span>"),n.hasOwnProperty("isNew")&&n.isNew&&(a.isRead=0);var a=i.tmpl(t,a),s=r.find(".popup-messages");s.append(a),setTimeout(function(){s.scrollTop(5e4)},10)});var t,e=i.$connectionsPanel.find("#chatgroup_"+n.groupId);e.length&&0!=e.index()&&(t=e.clone(),e.remove(),i.$connectionsPanel.find("#grouplistbox").prepend(t))},t.prototype.getChatDiv=function(t){return u("#chatbox-"+t)},t.prototype.getGroupChatDiv=function(t){return u("#groupchatbox-"+t)},t.prototype.startUserTyping=function(t){var e,t=this.getChatDiv(t);t.length&&((e=t.find(".popup-messages")).find(".chatdot-typing-icon").length||(e.append('<div class="chat-user-message notown d-flex justify-content-start chatdot-typing-icon"><div class="d-flex flex-column"><div class="msg_container"><div class="chatdot-typing"></div></div></div><div class="clearfix"></div></div>'),e.scrollTop(5e4),setTimeout(function(){e.find(".chatdot-typing-icon").remove()},5e3)))},t.prototype.stopUserTyping=function(t){t=this.getChatDiv(t);t.length&&t.find(".popup-messages .chatdot-typing-icon").remove()},t.prototype.readUserMessage=function(t){var e=t.connectionId,o=this.getChatDiv(e);o.length&&(t.hasOwnProperty("me")&&1==t.me?(o.removeClass("chat-popup-unread"),o.find(".chat-header-unread").removeClass("chat-header-unread"),0==this.$chatboxes.find(".chat-header-unread").length&&chatPageTitleNotifyOff(),getChatMessageIdsByElement(e,o)):(e=t.readDate,t=o.find(".popup-messages"),o=o.find(".popup-head img.user_img").attr("src"),t.find(".chat-message-read").remove(),t.append('<span class="chat-message-read"><img src="'+o+'" title="'+e+'" onerror="onChatUserImgError(this);"></span>'),t.scrollTop(5e4)))},t.prototype.readUserGroupMessage=function(t){var e=t.connectionId,e=this.getGroupChatDiv(e);e.length&&t.hasOwnProperty("me")&&1==t.me&&(e.find(".chat-header-unread").removeClass("chat-header-unread"),0==this.$chatboxes.find(".chat-header-unread").length&&chatPageTitleNotifyOff())},t.prototype.removeUserMessage=function(t){t=u('.chat-user-message[data-mid="'+t.mid+'"]');t.length&&t.remove()},t.prototype.deleteUserConversations=function(t){var e=this.getChatDiv(t.connectionId);chatDeleteConversations(t.connectionId,e)},t.prototype.openUserChatBox=function(t){0==this.getChatDiv(t.connectionId).length&&this.renderChatBox({connectionId:t.connectionId,mid:null,isNew:!1,isReadUpdate:!0,isClickItem:!1})},t.prototype.closeUserChatBox=function(t){t=this.getChatDiv(t.connectionId);t.length&&(t.hasAttr("data-emoji")&&t.find("textarea[data-emoji]").emojiChooser("destroy"),this.initChatBoxResizableDestroy(t),t.remove(),this.setWidthChatBox())},t.prototype.openUserGroupChatBox=function(t){0==this.$chatboxesWide.find("#groupchatbox-"+t.connectionId).length&&this.renderGroupChatBox({groupId:t.connectionId,groupName:t.groupName,mid:null,isNew:!1,isReadUpdate:!0,isClickItem:!1})},t.prototype.closeUserGroupChatBox=function(t){t=this.$chatboxesWide.find("#groupchatbox-"+t.connectionId);t.length&&(t.hasAttr("data-emoji")&&t.find("textarea[data-emoji]").emojiChooser("destroy"),t.remove(),this.setWidthChatBox())},t.prototype.fileDownloadedMessage=function(t){t=u('.chat-user-message[data-mid="'+t.mid+'"]');t.length&&t.find(".media").append('<span class="chat-file-downloaded-icon" title="Татсан"><i class="icon-check"></i></span>')},t.prototype.renderPushUsersToGroup=function(o){var a=this,s=o.groupId;a.groups[s]=o.members;var t=u("#chatgroup_"+s);0==t.length?a.loadTplByName("tplGroup",function(t){var e={id:s,name:o.groupName,membercount:o.membersCount};u("#grouplistbox").prepend(a.tmpl(t,e))}):t.find(".chat-group-user-count").text(o.membersCount)},t.prototype.renderPushRemoveUsersToGroup=function(t){var e,o=t.groupId,a=u("#chatgroup_"+o);1==t.isRemovedUser?(e=u("#groupchatbox-"+o),delete this.groups[o],a.length&&a.remove(),e.length&&e.remove()):(this.groups[o]=t.members,a.length&&a.find(".chat-group-user-count").text(t.membersCount))},t.prototype.renderRenameGroup=function(t){var e=t.groupId,o=u("#chatgroup_"+e),e=u("#groupchatbox-"+e);o.length&&o.find(".chat-group-name").html(t.groupName),e.length&&e.find(".username").html(t.groupName).attr("title",t.groupName)},t.prototype.renderDeleteGroup=function(t){var e=t.groupId,o=u("#chatgroup_"+e),t=u("#groupchatbox-"+e);o.length&&o.remove(),t.length&&t.remove(),delete this.groups[e]},t.prototype.renderExitGroup=function(t){var e=t.groupId,o=u("#chatgroup_"+e);o.length&&o.find(".chat-group-user-count").text(t.membersCount),delete this.groups[e][t.connectionId]},t.prototype.toTopUser=function(t,e){var o=this.users,a=o["_"+t];a.lastChatId=e,delete o["_"+t];e={};e["_"+t]=a,o=Object.assign(e,o),this.users=o}},u.fn.mgVideoChatUtils=function(t,o){t.prototype.fixPath=function(){var e,o;"{rel}"==this.rtcConfig.dir&&(e=this,o="chat-",u('script[src*="chat-"]').each(function(){var t=u(this).attr("src");t&&-1!==t.indexOf(o,this.length-o.length)&&(e.rtcConfig.dir=t.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,""),e.version=34)}))},t.prototype.debug=function(t){this.rtcConfig.debug&&console.log(t)},t.prototype.getErrorText=function(t){var e=[];return t.code&&e.push(t.code),t.name&&e.push(t.name),t.message&&e.push(t.message),0==e.length&&e.push(t),"PermissionDeniedError"!=e[0]&&"PERMISSION_DENIED"!=e[0]||(o.firefox?e.push(this._("Please enable requested media devices")):e.push(this._("Please enable requested media devices by clicking on the right hand icon in the address bar."))),e.join(".\n")},t.prototype.getReadableFileSizeString=function(t){if(0==t)return"0 Byte";var e=parseInt(Math.floor(Math.log(t)/Math.log(1024)));return Math.round(t/Math.pow(1024,e),2)+" "+["Bytes","KB","MB","GB","TB"][e]},t.prototype.parseChatMessageText=function(t){return":buzz"==t?'<i class="icon-bell3"></i>':nl2br(linkify(html_entity_decode(t,"ENT_QUOTES")),!1)},t.prototype.parseChatMessageFile=function(t,e){var o=t.split("$$"),a=o[0],s=o[1],n=o[2],i=o[3],t="";return o.hasOwnProperty(5)&&(t='<div class="mb5">'+o[5]+"</div>"),"png"==i||"jpg"==i||"jpeg"==i||"gif"==i||"bmp"==i?t+'<div class="chat-photofile-name">'+a+'</div><img src="api/image_thumbnail?width=250&src='+s+n+'" data-real-src="'+s+n+'" class="chat-upload-photo">':(o=o[4],e="1"==e?'<span class="chat-file-downloaded-icon" title="Татсан"><i class="icon-check"></i></span>':"",t+'<div class="media"><div class="mr-2 align-self-center">'+("doc"==i||"docx"==i?'<i class="icon-file-word icon-2x top-0"></i>':"xls"==i||"xlsx"==i?'<i class="icon-file-excel icon-2x top-0"></i>':"ppt"==i||"pptx"==i?'<i class="icon-book-play icon-2x top-0"></i>':"pdf"==i?'<i class="icon-file-pdf icon-2x top-0"></i>':'<i class="icon-attachment icon-2x top-0"></i>')+'</div><div class="media-body"><div class="font-weight-semibold">'+a+'</div><div class="font-size-sm">Size: '+this.getReadableFileSizeString(o)+'</div></div><div class="ml-2"><div class="list-icons"><a href="javascript:;" class="list-icons-item chat-file-download-btn" title="Татах"><i class="icon-download"></i></a></div></div>'+e+"</div>")},t.prototype.parseChatForwardText=function(t,e){var o=e.msg,a="";return void 0!==o&&""!=o&&null!==o&&(a='<div class="chat-forward-msg-parent">',a+='<span class="chat-forward-msg">'+(o=-1!==o.indexOf("$$")&&3<o.split("$$").length?this.parseChatMessageFile(o):this.parseChatMessageText(o))+"</span>",a+='<span class="chat-forward-name-date">'+e.userFullName+", "+date("Y/m/d H:i",strtotime(e.createdDate))+"</span>",a+="</div>"),a+this.parseChatMessageText(t)};var a={};t.prototype.tmpl=function(e,t){try{var o=/\W/.test(e)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):a[e]=a[e]||tmpl(r.getElementById(e).innerHTML);return t?o(t):o}catch(t){throw new Error("Error parsing template ["+e.substr(0,100)+"...]")}};var s={};t.prototype.loadTplByName=function(t,e){return this.loadTpl(this.rtcConfig.dir+this.rtcConfig[t]+"?v="+this.version,t,e)},t.prototype.loadTpl=function(t,e,o){return void 0===s[e]?u.ajax({type:"get",url:t,async:!1,dataType:"html",success:function(t){s[e]=t,o&&o(t)}}):o&&o(s[e]),s[e]},t.prototype.on=function(t,e){this.events[t]=this.events[t]||[],this.events[t].push(e)},t.prototype.fire=function(t,e){this.debug("mgVideoChat fired ["+t+"]");var o=this.events[t],a=Array.prototype.slice.call(arguments,1);if(o)for(var s=0,n=o.length;s<n;s++)o[s].apply(null,a)};var n=null;t.prototype.message=function(t,e,o){n&&i.clearTimeout(n),t&&(o&&(n=i.setTimeout(function(){n=null},1e3*o)),console.log(t))}}}(jQuery,window,document),function(i){var o,a={dir:"{rel}",tplConnections:"/tpls/connections.html",tplConnection:"/tpls/connection.html",tplChat:"/tpls/chat.html",tplChatBox:"/tpls/chatbox.html",tplGroup:"/tpls/groupItem.html",tplGroupChatBox:"/tpls/groupchatbox.html",tplGroupChat:"/tpls/groupchat.html",sound:{mp3:"/sounds/ring.mp3",ogg:"/sounds/ring.ogg"},notifySound:{mp3:"/sounds/notify.mp3",ogg:"/sounds/notify.ogg"},chromeExtensionId:"jfepeciommhoefhfacjdpcmnclekenag"},n=function(t,e){this.version="1",this.elem=t,this.$elem=i(t),this.$connectionsPanel=null,this.rtcConfig=i.extend({},a,rtcConfig),o=i.fn.mgDesktopShare(rtc),i.fn.mgVideoChatUtils(n,rtc),i.fn.mgVideoChatUI(n,rtc,o),i.fn.mgVideoChatRtcEvents(n,rtc,notificationsHelper),this.fixPath(),this.init(),this.$elem.data("mgVideoChat-instance",this),this.events={}};n.prototype.init=function(){var t=this;t.$chatToggleBtn=i("#chat-toggle-button"),t.$connectionsPanel=t.$elem,t.$chatboxes=i("#chatboxes"),t.$chatboxesWide=i("#chatboxes_wide"),t.initRtc()},n.prototype.onConnected=function(){this.$chatToggleBtn.hasAttr("data-readystate")&&(this.$chatToggleBtn.show(),this.$chatToggleBtn.attr("data-readystate","1"))},n.prototype.onDisconnected=function(){this.disableChat()},n.prototype.onLogged=function(){},n.prototype.onConnectionClose=function(t){var e=this;"online"==e.contactsView?e.$connectionsPanel.find("#connection_"+t).remove():e.$connectionsPanel.find("#connection_"+t+" .is-online").removeClass("online_icon chat_idle_icon"),e.$chatboxesWide.find("#chatbox-"+t+" .is-online").removeClass("online_icon chat_idle_icon"),e.$chatboxesWide.find(".chatuser-"+t+" .is-online").removeClass("chat-group-online-icon chat-group-idle-icon"),e.disableChat(t),e.fire("connections",rtc.connections)},n.prototype.notifySound=function(){"undefined"!=typeof pageTitleNotification&&pageTitleNotification.on(plang.get("unread_sms"),1e3)},n.prototype.hasMedia=function(t,e){try{return 0<("audio"==e?t.getAudioTracks():t.getVideoTracks()).length}catch(t){return!1}},n.prototype.getMediaOptions=function(t){return t.video=t.video&&!rtc.roomOptions.disableVideo,t.audio=t.audio&&!rtc.roomOptions.disableAudio,t},n.prototype.onRoomOptions=function(){var t=-1<navigator.userAgent.toLowerCase().indexOf("chrome");rtc.roomOptions.desktopShare=rtc.roomOptions.desktopShare&&t},n.prototype.disableChat=function(t){t?this.$chatboxesWide.find("#chatbox-"+t+" .is-online").removeClass("online_icon chat_idle_icon"):console.log("disableChat")},i.fn.mgVideoChat=function(t,e,o){if("on"!==t){var a=[];return this.each(function(){a.push(new n(this,t))}),1===a.length?a[0]:a}var s=i(this).data("mgVideoChat-instance");if(s)return s.on(e,o)},n.prototype.initUsers=function(){var e=this;i.ajax({type:"post",url:"chat/index",success:function(t){e.users=t.users,e.groups=t.groups,e.contactsView=t.contactsView,e.userStatus=t.status,e.contactsCount=Object.keys(t.users).length,e.supportUserId=t.supportUserId,e.supportUserId&&e.contactsCount&&(e.contactsCount=e.contactsCount-1),e.$chatToggleBtn.attr("data-readystate",rtc._socket.readyState),1==rtc._socket.readyState&&e.$chatToggleBtn.show(),e.newMsgChatDefaultOpen()},error:function(){console.log("get userlist error")}})},n.prototype.newMsgChatDefaultOpen=function(){for(var t in this.users)"0"!=this.users[t].unReadCount&&this.renderChatBox({connectionId:this.users[t].userId,mid:null,isNew:!0,isReadUpdate:!1,isClickItem:!1,ignoreIncreaseUnread:!0})},i.fn.mgVideoChat._=function(t,e,o){var a,s=t;if(i.fn.mgVideoChat.translate&&i.fn.mgVideoChat.translate[t]&&(s=i.fn.mgVideoChat.translate[t]),!e||!e.length)return s;for(var n=0;n<e.length;n++)a=new RegExp(e[n],"g"),s=s.replace(a,o[n]);return s},i.fn.mgVideoChat.htmlspecialchars=function(t,e,o,a){if(null==t)return"";var s=0,n=0,i=!1;null==e&&(e=2),t=t.toString(),!1!==a&&(t=t.replace(/&/g,"&amp;")),t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");var r={ENT_NOQUOTES:0,ENT_HTML_QUOTE_SINGLE:1,ENT_HTML_QUOTE_DOUBLE:2,ENT_COMPAT:2,ENT_QUOTES:3,ENT_IGNORE:4};if(0===e&&(i=!0),"number"!=typeof e){for(e=[].concat(e),n=0;n<e.length;n++)0===r[e[n]]?i=!0:r[e[n]]&&(s|=r[e[n]]);e=s}return e&r.ENT_HTML_QUOTE_SINGLE&&(t=t.replace(/'/g,"&#039;")),i||(t=t.replace(/"/g,"&quot;")),t}}(jQuery,(window,document)),$(function(){var t,e=$("#chat-toggle-button"),i=0,r=0,c=0;void 0!==$.cookie("chat_button_position")&&null!==$.cookie("chat_button_position")&&""!=$.cookie("chat_button_position")&&(t=JSON.parse($.cookie("chat_button_position")),isObject(t)&&t.hasOwnProperty("bottom")&&t.hasOwnProperty("right")&&(e.css("bottom",t.bottom+"px"),e.css("right",t.right+"px"))),e.draggable({start:function(t,e){i=$(window).width(),r=$(window).height(),c=$(e.helper).height()},stop:function(t,e){var o=r-e.offset.top-c,a=i-e.offset.left-c,s=o,n=a,e=$(e.helper);250<o&&(s=250,e.css("top",""),e.css("bottom",s)),o<40&&(s=40,e.css("top",""),e.css("bottom",s)),o<0&&(s=75,e.css("top",""),e.css("bottom",s)),250<a&&(n=250,e.css("left",""),e.css("right",n)),a<0&&(n=15,e.css("left",""),e.css("right",n)),$.cookie("chat_button_position",'{"bottom":'+s+',"right":'+n+"}",{expires:365,path:"/"})}}),e.on("click",function(){mgChat.renderConnections(),setTimeout(function(){var t=$(".chatBox");t.addClass("showBox"),mgChat.setWidthChatBox(),t.hasClass("ui-resizable")||t.resizable({handles:"n",minHeight:200,maxHeight:$(window).height()-10,resize:function(t,e){var o=$(this);o.css({top:"",height:""}),o.find(".chat_contacts_body, .chat_groups_body").css("height",e.size.height-100)}})},5)}),$(document.body).on("click",".chat-user-item",function(){var t=$(this).attr("data-connection_id");$(".qtip").qtip("toggle",!1),mgChat.renderChatBox({connectionId:t,mid:null,isNew:!1,isReadUpdate:!0,isClickItem:!0}),rtc.openChatBox(t)}),$(document.body).on("click",".chatbox-close",function(){var t,e=$(this).closest(".chat-popup");e.hasClass("group-chat-popup")?(t=e.attr("data-gid"),rtc.closeGroupChatBox(t)):(t=e.attr("data-cid"),rtc.closeChatBox(t)),e.hasAttr("data-emoji")&&e.find("textarea[data-emoji]").emojiChooser("destroy"),mgChat.initChatBoxResizableDestroy(e),e.remove(),mgChat.setWidthChatBox()}),$(document.body).on("click",".chatbox-minimize",function(){var t=$(this),e=t.closest(".chat-popup");e.hasClass("chatbox-minimized-box")?(e.removeClass("chatbox-minimized-box"),t.find("i").removeClass("fa-window-maximize mt6").addClass("fa-window-minimize")):(e.addClass("chatbox-minimized-box"),t.find("i").removeClass("fa-window-minimize").addClass("fa-window-maximize mt6"))}),$(document.body).on("click",".chat-connections-close",function(){$(".chatBox").removeClass("showBox"),mgChat.setWidthChatBox()}),$(document.body).on("keypress",".private-chat-popup > .chat-input-text > form > textarea",function(t){var e=$(this),o=e.attr("data-ctid"),a=(i=e.val().trim()).replace(/\n/g,"");if(13===t.keyCode&&t.shiftKey)return a&&e.val(i+"\n"),!1;if(13===t.keyCode&&a&&""!=i){e.hasAttr("data-emoji")&&(e.emojiChooser("destroy"),e.removeAttr("data-emoji"),e.closest(".chat-popup").removeAttr("data-emoji"));var s=getUidSysdate(),n=s.id,s=s.date,i=encodeEmojis(i);return rtc.chatMessage(o,rtc.connectionId,i,n,s,!1),rtc.stopTyping(o),mgChat.renderChatMessage({chatId:o,fromId:rtc.connectionId,message:i,mid:n,sysDateTime:s,isFile:!1}),mgChat.toTopUser(o,n),e.val(""),!1}if(13===t.keyCode&&!a)return!1;rtc.startTyping(o)}),$(document.body).on("keyup",".private-chat-popup > .chat-input-text > form > textarea",function(t){var e;8!==t.keyCode&&46!==t.keyCode||(t=(e=$(this)).val(),e=e.attr("data-ctid"),t?rtc.startTyping(e):rtc.stopTyping(e))}),$(document.body).on("keyup","#chat_namesearch",function(t){var e=$(this),o=e.val(),a=t.keyCode||t.which;if("contacts"==e.attr("data-where"))if(1<o.length){var s=mgChat.users,n=new RegExp(o,"i");if("org"==mgChat.contactsView){var t=$(".chat-org-item"),i=o.toLowerCase(),e=t.filter(function(){var t=!0;return-1===$(this).attr("data-orgname").toLowerCase().indexOf(i)&&(t=!1),!0!==t});t.css({display:""}),e.css({display:"none"})}else{var r,c=mgChat.$connectionsPanel.find("#userlistbox");for(r in c.empty(),s)r=r.replace("_",""),mgChat.supportUserId!=r&&(n.test(s["_"+r].firstName)||n.test(s["_"+r].departmentName))&&mgChat.renderConnection(r);mgChat.setChatUserToolip(c)}}else 8!=a&&46!=a||("recent"==mgChat.contactsView?mgChat.renderContactsRecent(!1):"online"==mgChat.contactsView?mgChat.renderContactsOnline(!1):"offline"==mgChat.contactsView?mgChat.renderContactsOffline(!1):"org"==mgChat.contactsView?$(".chat-org-item").css({display:""}):mgChat.renderContactsAll(!1));else{var d,c=$("ul#grouplistbox > li");c.length&&(d=!0,a=c.filter(function(){var t=$(this);return d=!0,-1===t.find(".chat-group-name").text().toLowerCase().indexOf(o)&&(d=!1),!0!==d}),c.css({display:""}),a.css({display:"none"}))}}),$(document.body).on("change",".private-chat-popup > .chat-input-text > form > label > input",function(){var s,n,i;rtc._socketTimer||(s=$(this),n=s.closest(".private-chat-popup"),i=n.attr("data-cid"),s.closest("form").ajaxSubmit({type:"post",url:"chat/attachFile",dataType:"json",beforeSend:function(){Core.blockUI({target:n,message:"Uploading...",boxed:!0})},success:function(t){if(PNotify.removeAll(),"success"==t.status){rtc.stopTyping(i);var e,o=t.list,a=t.dateTime;for(e in o)rtc.chatMessage(i,rtc.connectionId,o[e].fileInfo,o[e].uid,a,!0),mgChat.renderChatMessage({chatId:i,fromId:rtc.connectionId,message:o[e].fileInfo,mid:o[e].uid,sysDateTime:a,isFile:!0});mgChat.toTopUser(i,o[e].uid),s.val("")}else new PNotify({title:t.status,text:t.message,type:t.status});Core.unblockUI(n)}}))}),$(document.body).on("click",".private-chat-popup.chat-popup-unread > .popup-messages, .private-chat-popup.chat-popup-unread > .chat-input-text",function(){var t=$(this).closest(".private-chat-popup"),e=t.attr("data-cid");t.removeClass("chat-popup-unread"),t.find(".chat-header-unread").removeClass("chat-header-unread"),chatPageTitleNotifyOff(),rtc.readMessage(e),$.ajax({type:"post",url:"chat/readMessage",data:{mids:getChatMessageIdsByElement(e,t)},dataType:"json",success:function(t){"error"==t.status&&console.log(t)}})}),$(document.body).on("click",".group-chat-popup",function(){var t=$(this),e=t.find(".chat-header-unread");e.length&&(e.removeClass("chat-header-unread"),t=t.attr("data-gid"),chatPageTitleNotifyOff(),rtc.readGroupMessage(t))}),$(document.body).on("focusin",".chat-popup textarea",function(){$(this).closest(".msg-footer").addClass("chat-focus-text")}),$(document.body).on("focusout",".chat-popup textarea",function(){$(this).closest(".msg-footer").removeClass("chat-focus-text")}),$(document.body).on("click",".chat-upload-photo",function(){var t=$(this),e=t.attr("data-real-src"),o=t.prev(".chat-photofile-name").text(),a=t.closest(".chat-user-message").attr("data-mid");$.fancybox.defaults.btnTpl.download2=$.fancybox.defaults.btnTpl.download.replace("data-fancybox-download",""),$.fancybox.open([{src:e,opts:{caption:o}}],{buttons:["zoom","download2","close"],beforeShow:function(t,e){t.$refs.container.find(".fancybox-button--download").attr("href","chat/downloadFile/"+a)}})}),$(document.body).on("click","#chat-create-group",function(){$.ajax({type:"post",url:"chat/addGroup",dataType:"json",success:function(t){var e="dialog-chat-create-group";$("#"+e).length||$('<div id="'+e+'"></div>').appendTo("body");var o=$("#"+e);o.empty().append(t.html),o.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Чат групп үүсгэх",width:500,height:"auto",modal:!0,position:{my:"top",at:"top+50"},buttons:[{text:plang.get("create_btn"),class:"btn green-meadow btn-sm",click:function(){$("#chat-create-group-form").validate({errorPlacement:function(){}}),$("#chat-create-group-form").valid()&&$.ajax({type:"post",url:"chat/createGroup",data:$("#chat-create-group-form").serialize(),dataType:"json",beforeSend:function(){Core.blockUI({message:"Loading...",boxed:!0})},success:function(t){PNotify.removeAll(),"success"==t.status?(o.dialog("close"),mgChat.newGroupItemRender(t.id,t.name,t.membersCount),t.isAddUsers&&mgChat.addUsersToGroup(t.id,t.name,t.addedUsers,t.membersCount)):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),Core.unblockUI()},error:function(){alert("Error")}})}},{text:plang.get("close_btn"),class:"btn blue-madison btn-sm",click:function(){o.dialog("close")}}]}),setTimeout(function(){Core.initSelect2(o),o.dialog("open")},1)}})}),$(document.body).on("show.bs.tab",'a[href="#chat-groups"]',function(){$("#chat_namesearch").attr("data-where","groups"),$(".chat-view-dropdown").hide(),mgChat.renderGroups()}),$(document.body).on("show.bs.tab",'a[href="#chat-contacts"]',function(){$("#chat_namesearch").attr("data-where","contacts"),$(".chat-view-dropdown").show()}),$(document.body).on("click",".chat-group-item",function(){var t=$(this),e=t.attr("data-chatgroupid"),t=t.find(".chat-group-name").text();mgChat.renderGroupChatBox({groupId:e,groupName:t,mid:null,isNew:!1,isReadUpdate:!0,isClickItem:!0}),rtc.openGroupChatBox(e,t)}),$(document.body).on("click",".chat-group-options-btn",function(){var e=$(this).closest(".chat-popup").attr("data-gid"),t="dialog-chat-group-options";$("#"+t).length||$('<div id="'+t+'"></div>').appendTo("body");var o=$("#"+t);$.ajax({type:"post",url:"chat/editGroup",data:{groupId:e},dataType:"json",success:function(t){o.empty().append(t.html),o.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Чат групп засах",width:550,height:"auto",modal:!0,position:{my:"top",at:"top+50"},close:function(){o.empty().dialog("destroy").remove()},buttons:[{text:plang.get("save_btn"),class:"btn green-meadow btn-sm",click:function(){$("#chat-edit-group-form").validate({errorPlacement:function(){}}),$("#chat-edit-group-form").valid()&&$.ajax({type:"post",url:"chat/updateGroup",data:$("#chat-edit-group-form").serialize(),dataType:"json",beforeSend:function(){Core.blockUI({message:"Loading...",boxed:!0})},success:function(t){PNotify.removeAll(),"success"==t.status?(o.dialog("close"),t.isRemoveUsers&&mgChat.removeUsersToGroup(e,t.removedUsers,t.membersCount),t.isAddUsers&&mgChat.addUsersToGroup(e,t.groupName,t.addedUsers,t.membersCount),t.isGroupRename&&mgChat.renderGroupRename(e,t.groupName)):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),Core.unblockUI()},error:function(){alert("Error")}})}},{text:plang.get("close_btn"),class:"btn blue-madison btn-sm",click:function(){o.dialog("close")}}]}),setTimeout(function(){o.dialog("open")},100)}})}),$(document.body).on("click",".chat-group-delete-btn",function(){var e=$(this).closest("form").find('input[type="hidden"]').val(),t="dialog-chat-msg-confirm";$("#"+t).length||$('<div id="'+t+'"></div>').appendTo("body");var o=$("#"+t);o.empty().append(plang.get("msg_delete_confirm")),o.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:plang.get("msg_title_confirm"),width:350,height:"auto",modal:!0,buttons:[{text:plang.get("yes_btn"),class:"btn green-meadow btn-sm",click:function(){$.ajax({type:"post",url:"chat/groupDelete",data:{groupId:e},dataType:"json",success:function(t){PNotify.removeAll(),"success"==t.status?(mgChat.groupDelete(e),$("#dialog-chat-group-options").dialog("close"),o.dialog("close")):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1})},error:function(){alert("Error")}})}},{text:plang.get("no_btn"),class:"btn blue-madison btn-sm",click:function(){o.dialog("close")}}]}),o.dialog("open")}),$(document.body).on("click",".chat-group-exit-btn",function(){var e=$(this).closest("form").find('input[type="hidden"]').val(),t="dialog-chat-msg-confirm";$("#"+t).length||$('<div id="'+t+'"></div>').appendTo("body");var o=$("#"+t);o.empty().append(plang.get("msg_delete_confirm")),o.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Confirm",width:350,height:"auto",modal:!0,buttons:[{text:plang.get("yes_btn"),class:"btn green-meadow btn-sm",click:function(){$.ajax({type:"post",url:"chat/groupExit",data:{groupId:e},dataType:"json",success:function(t){PNotify.removeAll(),"success"==t.status?(mgChat.groupExit(e),$("#dialog-chat-group-options").dialog("close"),o.dialog("close")):new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1})},error:function(){alert("Error")}})}},{text:plang.get("no_btn"),class:"btn blue-madison btn-sm",click:function(){o.dialog("close")}}]}),o.dialog("open")}),$(document.body).on("keypress",".group-chat-popup > .chat-input-text > form > textarea",function(t){var e=$(this),o=t.keyCode,a=(i=e.val().trim()).replace(/\n/g,"");if(13===o&&t.shiftKey)return a&&e.val(i+"\n"),!1;var s=e.attr("data-gid");if(13===o&&a&&""!=i){e.hasAttr("data-emoji")&&(e.emojiChooser("destroy"),e.removeAttr("data-emoji"),e.closest(".chat-popup").removeAttr("data-emoji"));var n=getUidSysdate(),o=n.id,n=n.date,i=encodeEmojis(i);return rtc.groupChatMessage(s,e.closest(".group-chat-popup").find(".username").html(),mgChat.groups[s],i,o,n,!1),mgChat.renderGroupChatMessage({groupId:s,fromId:rtc.connectionId,message:i,mid:o,sysDateTime:n,isFile:!1}),e.val(""),!1}return!(13===t.keyCode&&!a)&&void 0}),$(document.body).on("change",".group-chat-popup > .chat-input-text > form > label > input",function(){var i,r,c;rtc._socketTimer||(i=$(this),r=i.closest(".group-chat-popup"),c=r.attr("data-gid"),i.closest("form").ajaxSubmit({type:"post",url:"chat/attachFile",dataType:"json",beforeSend:function(){Core.blockUI({target:r,message:"Uploading...",boxed:!0})},success:function(t){if(PNotify.removeAll(),"success"==t.status){var e,o=t.list,a=t.dateTime,s=r.find(".username").html(),n=mgChat.groups[c];for(e in o)rtc.groupChatMessage(c,s,n,o[e].fileInfo,o[e].uid,a,!0),mgChat.renderGroupChatMessage({groupId:c,fromId:rtc.connectionId,message:o[e].fileInfo,mid:o[e].uid,sysDateTime:a,isFile:!0});i.val("")}else new PNotify({title:t.status,text:t.message,type:t.status});Core.unblockUI(r)}}))}),$(document.body).on("click","#chat-mass-message",function(){$.ajax({type:"post",url:"chat/massMessageForm",dataType:"json",beforeSend:function(){Core.blockUI({message:"Loading...",boxed:!0})},success:function(t){var e="dialog-chat-mass-message";$("#"+e).length||$('<div id="'+e+'"></div>').appendTo("body");var s=$("#"+e);s.empty().append(t.html),s.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Mass message",width:500,height:"auto",modal:!0,position:{my:"top",at:"top+50"},close:function(){s.empty().dialog("destroy").remove()},buttons:[{text:plang.get("send_btn"),class:"btn green-meadow btn-sm",click:function(){var t=$("#chat-massmsg-form");t.validate({errorPlacement:function(){}}),t.valid()&&t.ajaxSubmit({type:"post",url:"chat/sendMassMessage",dataType:"json",beforeSend:function(){Core.blockUI({message:"Sending...",boxed:!0})},success:function(t){if(PNotify.removeAll(),"success"==t.status){s.dialog("close");var e,o,a=t.list;for(o in a)e=1==a[o].isFile,rtc.chatMessageNotAjax(a[o].chatId,a[o].msg,a[o].mid,a[o].dateTime,e,1),mgChat.renderChatMessage({chatId:a[o].chatId,fromId:rtc.connectionId,message:a[o].msg,mid:a[o].mid,sysDateTime:a[o].dateTime,isFile:e,isMass:1})}else new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1});Core.unblockUI()},error:function(){alert("Error")}})}},{text:plang.get("close_btn"),class:"btn blue-madison btn-sm",click:function(){s.dialog("close")}}]}),setTimeout(function(){s.dialog("open"),Core.initSelect2(s)},100),Core.unblockUI()}})}),$(document.body).on("click",".chat-file-download-btn",function(){Core.blockUI({message:"Downloading...",boxed:!0});var t=$(this),e=t.closest(".chat-user-message"),t=t.closest(".chat-popup"),o=e.attr("data-mid"),a=t.attr("data-cid");$.fileDownload(URL_APP+"chat/downloadFile",{httpMethod:"POST",data:{msgId:o},successCallback:function(t){rtc.fileDownloaded(a,o),Core.unblockUI()},prepareCallback:function(t){Core.unblockUI()},failCallback:function(t,e){PNotify.removeAll(),new PNotify({title:"Error",text:t,type:"error",sticker:!1}),Core.unblockUI()}})}),$(document.body).on("click",".chat-view-dropdown a.dropdown-item",function(){var t=$(this).attr("data-view");mgChat.selectedContactsView(t),"recent"==t?mgChat.renderContactsRecent(!0):"online"==t?mgChat.renderContactsOnline(!0):"offline"==t?mgChat.renderContactsOffline(!0):"org"==t?mgChat.renderContactsOrg(!0):mgChat.renderContactsAll(!0),mgChat.contactsView=t,$(".chat_contacts_body").scrollTop(0),$.ajax({type:"post",url:"chat/saveContactViewMode",data:{view:t},dataType:"json",success:function(t){console.log(t)}})}),$(document.body).on("shown.bs.collapse","#chat-org-accordion",function(t){var t=$($(t.target).data("bs.collapse")._triggerArray).attr("data-id"),o=$("#chat-org-accordion"+t);0==o.children().length&&$.ajax({type:"post",url:"chat/getChatContactsByOrgId",data:{orgId:t},dataType:"json",success:function(t){for(var e in t)mgChat.getConnectionElement(t[e].USER_ID,function(t){o.append(t)});mgChat.setChatUserToolip(o)}})}),$(document.body).on("click",".chat-emoji",function(){var t,o,a;rtc._socketTimer||(t=$(this),o=t.parent(),a=o.find("textarea"),$().emojiChooser?t.hasAttr("data-emoji")?a.emojiChooser("toggle"):(a.emojiChooser({mode:"chat",width:"300px",height:"279px",position:"top",recentCount:10,button:!1,footer:!1}),a.emojiChooser("toggle"),o.closest(".chat-popup").attr("data-emoji","1")):($("head").append('<link rel="stylesheet" type="text/css" href="assets/custom/addon/plugins/emoji-picker/css/jquery.emojichooser.css?v=4"/>'),$.cachedScript("assets/custom/addon/plugins/emoji-picker/js/jquery.emojichooser.js").done(function(t,e){a.emojiChooser({mode:"chat",width:"300px",height:"279px",position:"top",recentCount:10,button:!1,footer:!1}),a.emojiChooser("toggle"),o.closest(".chat-popup").attr("data-emoji","1")})))}),$(document.body).on("click",".chat-buzz",function(){var t,e,o;rtc._socketTimer||(t=$(this).closest(".chat-popup").attr("data-cid"),e=(o=getUidSysdate()).id,o=o.date,rtc.chatMessage(t,rtc.connectionId,":buzz",e,o,!1),rtc.stopTyping(t),mgChat.renderChatMessage({chatId:t,fromId:rtc.connectionId,message:":buzz",mid:e,sysDateTime:o,isFile:!1}),bpSoundPlay("bell"),mgChat.toTopUser(t,e))}),$(document.body).on("click",".chat-delete-conversations",function(){var e=$(this).closest(".chat-popup"),o=e.attr("data-cid"),t="dialog-chat-msg-confirm";$("#"+t).length||$('<div id="'+t+'"></div>').appendTo("body");var a=$("#"+t);a.empty().append(plang.get("msg_delete_confirm")),a.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Confirm",width:350,height:"auto",modal:!0,buttons:[{text:plang.get("yes_btn"),class:"btn green-meadow btn-sm",click:function(){a.dialog("close"),$.ajax({type:"post",url:"chat/deleteConversations",data:{chatId:o},dataType:"json",beforeSend:function(){Core.blockUI({target:e,animate:!0})},success:function(t){PNotify.removeAll(),new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),"success"==t.status&&(chatDeleteConversations(o,e),rtc.deleteConversations(o)),Core.unblockUI(e)},error:function(){alert("Error")}})}},{text:plang.get("no_btn"),class:"btn blue-madison btn-sm",click:function(){a.dialog("close")}}]}),a.dialog("open")}),$(document.body).on("show.bs.dropdown","#chat-status-dropdown",function(){var a=$(".chat-user-status-dropdown ul.media-list");0==a.children().length&&$.ajax({type:"post",url:"chat/getUserStatus",dataType:"json",beforeSend:function(){Core.blockUI({target:".chatBox",animate:!0})},success:function(t){if(t.length){var e,o=[];for(e in t)o.push(chatUserStatusItem({id:t[e].ID,status:t[e].STATUS,isActive:t[e].IS_ACTIVE}));a.empty().append(o.join(""))}Core.unblockUI(".chatBox")}})}),$(document.body).on("keydown",".chat-user-status-input",function(t){13==t.which&&$(this).closest(".input-group").find(".chat-user-status-button").click()}),$(document.body).on("click",".chat-user-status-button",function(){var e=$(".chat-user-status-input"),o=trim(e.val());""!=o&&$.ajax({type:"post",url:"chat/saveUserStatus",data:{status:o},dataType:"json",beforeSend:function(){Core.blockUI({target:".chat-user-status-dropdown",animate:!0})},success:function(t){PNotify.removeAll(),new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),"success"==t.status&&(e.val(""),$(".chat-user-status-dropdown ul.media-list").append(chatUserStatusItem({id:t.id,status:o,isActive:0}))),Core.unblockUI(".chat-user-status-dropdown")}})}),$(document.body).on("click",".chat-user-status-active",function(){var t=$(this),e=t.closest("li"),o=t.closest("ul"),a=1;t.hasClass("text-success")?(a=0,t.removeClass("text-success").addClass("text-default"),t.find(".icon-checkmark-circle").removeClass("icon-checkmark-circle").addClass("icon-circle")):(o.find(".text-success").removeClass("text-success").addClass("text-default"),o.find(".icon-checkmark-circle").removeClass("icon-checkmark-circle").addClass("icon-circle"),e.find(".text-default").removeClass("text-default").addClass("text-success"),e.find(".icon-circle").removeClass("icon-circle").addClass("icon-checkmark-circle")),$.ajax({type:"post",url:"chat/activeUserStatus",data:{id:e.attr("data-id"),isStatusActive:a},dataType:"json",success:function(t){PNotify.removeAll(),new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),"success"==t.status&&(t=1==a?e.find(".media-body").text():"",$(".chat-user-status").html(setChatUserStatus(t)),rtc.send({type:"userstatus",data:{status:t}}))}})}),$(document.body).on("click",'.chat-status-action[data-action="edit"]',function(){var t,e=$(this).closest("li");0==e.find('input[type="text"]').length&&(t=e.find(".media-body").text(),e.find(".media-body").empty().append('<input type="text" class="form-control form-control-sm chat-status-input" value="'+t+'"/>'),e.find(".media-body").find("input").focus().select())}),$(document.body).on("change",".chat-status-input",function(){var e=$(this).closest("li"),o=e.find("input").val();$.ajax({type:"post",url:"chat/updateUserStatus",data:{id:e.attr("data-id"),status:o},dataType:"json",success:function(t){PNotify.removeAll(),new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),"success"==t.status&&e.find(".text-success").length&&($(".chat-user-status").html(setChatUserStatus(o)),rtc.send({type:"userstatus",data:{status:o}}))}})}),$(document.body).on("focusout",".chat-status-input",function(){var t=$(this),e=t.closest("li"),t=t.val();e.find(".media-body").empty().append(t)}),$(document.body).on("click",'.chat-status-action[data-action="delete"]',function(){var t="dialog-chat-msg-confirm";$("#"+t).length||$('<div id="'+t+'"></div>').appendTo("body");var o=$("#"+t),a=$(this);o.empty().append(plang.get("msg_delete_confirm")),o.dialog({resizable:!0,bgiframe:!0,autoOpen:!1,title:"Confirm",width:350,height:"auto",modal:!0,buttons:[{text:plang.get("yes_btn"),class:"btn green-meadow btn-sm",click:function(){o.dialog("close");var e=a.closest("li");$.ajax({type:"post",url:"chat/deleteUserStatus",data:{id:e.attr("data-id")},dataType:"json",success:function(t){PNotify.removeAll(),new PNotify({title:t.status,text:t.message,type:t.status,sticker:!1}),"success"==t.status&&(e.find(".text-success").length&&($(".chat-user-status").html(setChatUserStatus("")),rtc.send({type:"userstatus",data:{status:""}})),e.remove())},error:function(){alert("Error")}})}},{text:plang.get("no_btn"),class:"btn blue-madison btn-sm",click:function(){o.dialog("close")}}]}),o.dialog("open")}),$(document.body).on("click","#chat-online-support",function(){var t=mgChat.supportUserId;mgChat.renderChatBox({connectionId:t,mid:null,isNew:!1,isReadUpdate:!0,isClickItem:!0}),rtc.openChatBox(t)}),$.contextMenu({selector:".chat-user-message.own .msg_container",className:"chat-contextmenu",events:{show:function(t){t.$trigger.css("box-shadow","0 0 8px rgba(0, 0, 0, 0.5)")},hide:function(t){t.$trigger.css("box-shadow","")}},callback:function(t,e){"remove"===t?chatRemoveMsg(e.$trigger):"forward"===t&&chatForwardMsg(e.$trigger)},items:{forward:{name:"Forward",icon:"share"},remove:{name:plang.get("delete_btn"),icon:"times-square"}}}),$.contextMenu({selector:".chat-user-message.notown .msg_container",className:"chat-contextmenu",events:{show:function(t){t.$trigger.css("box-shadow","0 0 8px rgba(0, 0, 0, 0.5)")},hide:function(t){t.$trigger.css("box-shadow","")}},callback:function(t,e){"forward"===t&&chatForwardMsg(e.$trigger)},items:{forward:{name:"Forward",icon:"share"}}})});var chatItemLimit=50,wsChatStatus="",mgChat=$("#mgVideoChat").mgVideoChat();